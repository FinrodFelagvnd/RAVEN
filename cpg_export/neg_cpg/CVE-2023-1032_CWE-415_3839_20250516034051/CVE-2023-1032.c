struct file *__sys_socket_file(int family, int type, int protocol)
{
	struct socket *sock;
	struct file *file;
	int flags;

	sock = __sys_socket_create(family, type, protocol);
	if (IS_ERR(sock))
		return ERR_CAST(sock);

	flags = type & ~SOCK_TYPE_MASK;
	if (SOCK_NONBLOCK != O_NONBLOCK && (flags & SOCK_NONBLOCK))
		flags = (flags & ~SOCK_NONBLOCK) | O_NONBLOCK;

	file = sock_alloc_file(sock, flags, NULL);
	if (IS_ERR(file))
		sock_release(sock);

	return file;
}