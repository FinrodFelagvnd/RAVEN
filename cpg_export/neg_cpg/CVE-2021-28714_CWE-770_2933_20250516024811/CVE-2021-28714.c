static bool xenvif_rx_ring_slots_available(struct xenvif_queue *queue)
{
	RING_IDX prod, cons;
	struct sk_buff *skb;
	int needed;
	unsigned long flags;

	spin_lock_irqsave(&queue->rx_queue.lock, flags);

	skb = skb_peek(&queue->rx_queue);
	if (!skb) {
		spin_unlock_irqrestore(&queue->rx_queue.lock, flags);
		return false;
	}

	needed = DIV_ROUND_UP(skb->len, XEN_PAGE_SIZE);
	if (skb_is_gso(skb))
		needed++;
	if (skb->sw_hash)
		needed++;

	spin_unlock_irqrestore(&queue->rx_queue.lock, flags);

	do {
		prod = queue->rx.sring->req_prod;
		cons = queue->rx.req_cons;

		if (prod - cons >= needed)
			return true;

		queue->rx.sring->req_event = prod + 1;

		/* Make sure event is visible before we check prod
		 * again.
		 */
		mb();
	} while (queue->rx.sring->req_prod != prod);

	return false;
}